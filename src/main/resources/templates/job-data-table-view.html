<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/headContent.html}">
    <title th:text="${pageTitle ?: 'Default Title'}">Job Details</title>




</head>
<body>

<header>Future Site Branding and Logo</header>

<a th:href="@{/}" >Return to Home</a>

<main>
    <h1 th:text="${pageTitle}"></h1>

    <p><strong>Report Time:</strong> <span th:text="${formattedTimestamp}"></span></p>
    <p><strong>Timestamp:</strong> <span th:text="${timestamp}"></span></p>
    <p><strong>Pbs Version:</strong> <span th:text="${pbsVersion}"></span></p>
    <p><strong>Pbs Server:</strong> <span th:text="${pbsServer}"></span></p>

    <table id="jobTable" class="table table-bordered table-striped">
        <thead class="table-header">
        <tr>
            <th>Job Key</th>
            <th>Job Name</th>
            <th>Job Owner</th>
            <th>Job State</th>
            <th>Queue</th>
            <th>Server</th>
            <th>Account Name</th>
            <th>Checkpoint</th>

            <th class="formatEpoch">Creation Time String</th>
            <th>Creation Time epoch</th>

            <th>Hold Types</th>
            <th>Join Path</th>
            <th>Keep Files</th>
            <th>Mail Points</th>

            <th class="formatEpoch">Modification Time String </th>
            <th>Modification Time Epoch</th>

            <th>Priority</th>

            <th class="formatEpoch">Queue Time String</th>
            <th>Queue Time Epoch</th>

            <th>Rerunable</th>

            <th class="formatEpoch">Start Time String</th>
            <th>Start Time Epoch</th>

            <th class="formatEpoch">Obit Time String</th>
            <th>Obit Time Epoch</th>

            <th>Shell Path List</th>
            <th>Job Directory</th>
            <th>Substate</th>
            <th>Comment</th>

            <th class="formatEpoch">Elapsed Time String</th>
            <th>Elapsed Time Epoch</th>

            <th>Umask</th>
            <th>Run Count</th>
            <th>Eligible Time</th>
            <th>Exit Status</th>
            <th>Submit Arguments</th>
            <th>Project</th>
            <th>Submit Host</th>
            <th>Server Instance ID</th>

            <!--Resource Columns -->
            <th class="memoryBytes">Memory Bytes</th>
            <th class="formattedMemory">Formatted Memory</th>

            <th>mpiprocs</th>
            <th>mps</th>
            <th>ncpus</th>
            <th>ngpus</th>
            <th>nodect</th>
            <th>place</th>
            <th>select</th>
            <th>walltime</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="job : ${jobs}">
            <td><span th:text="${job.jobId}"></span></td>
            <td><span th:text="${job.jobName}"></span></td>
            <td><span th:text="${job.jobOwner}"></span></td>
            <td><span th:text="${job.jobState}"></span></td>
            <td><span th:text="${job.queue}"></span></td>
            <td><span th:text="${job.server}"></span></td>
            <td><span th:text="${job.accountName}"></span></td>
            <td><span th:text="${job.checkpoint}"></span></td>

            <td class="formatEpoch" th:text="${job.ctime != null ? job.ctime : ''}"></td>
            <td><span th:text="${job.ctime}"></span> </td>

            <td><span th:text="${job.holdTypes}"></span></td> <!-- index 10-->
            <td><span th:text="${job.joinPath}"></span></td>
            <td><span th:text="${job.keepFiles}"></span></td>
            <td><span th:text="${job.mailPoints}"></span></td>

            <td class="formatEpoch" th:text="${job.mtime != null ? job.mtime : ''}"></td>
            <td><span th:text="${job.mtime}"></span> </td>

            <td><span th:text="${job.priority}"></span></td>

            <td class="formatEpoch" th:text="${job.qtime != null ? job.qtime : ''}"></td>
            <td><span th:text="${job.qtime}"></span></td>

            <td><span th:text="${job.rerunable}"></span></td>

            <td class="formatEpoch" th:text="${job.stime != null ? job.stime : ''}"></td> <!-- index 20-->
            <td><span th:text="${job.stime}"></span></td>

            <td class="formatEpoch" th:text="${job.obittime != null ? job.obittime : ''}"></td>
            <td><span th:text="${job.obittime}"></span> </td>

            <td><span th:text="${job.shellPathList}"></span></td>
            <td><span th:text="${job.jobdir}"></span></td>
            <td><span th:text="${job.substate}"></span></td>
            <td><span th:text="${job.comment}"></span></td>

            <td class="formatEpoch" th:text="${job.etime != null ? job.etime : ''}"></td>
            <td><span th:text="${job.etime}"></span> </td>

            <td><span th:text="${job.umask}"></span></td> <!-- index 30-->
            <td><span th:text="${job.runCount}"></span></td>
            <td><span th:text="${job.eligibleTime}"></span></td>
            <td><span th:text="${job.exitStatus}"></span></td>
            <td><span th:text="${job.submitArguments}"></span></td>
            <td><span th:text="${job.project}"></span></td>
            <td><span th:text="${job.submitHost}"></span></td>
            <td><span th:text="${job.serverInstanceId}"></span></td>

              <td th:text="${job.memoryBytes}"></td>
                <td th:text="${job.formattedMemory}"></td>

            <td th:text="${job.mpiprocs}"></td> <!-- index 40-->
            <td th:text="${job.mps}"></td>
            <td th:text="${job.ncpus}"></td>
            <td th:text="${job.ngpus}"></td>
            <td th:text="${job.nodect}"></td>

            <td th:text="${job.place}"></td>
            <td th:text="${job.select}"></td>
            <td th:text="${job.walltime}"></td>
        </tr>
        </tbody>
    </table>

</main>

<footer>
    <p>Copyright 2025 UCAR</p>
</footer>

<!--<script th:src="@{/js/dateTimeUtils.js}"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdn.datatables.net/datetime/1.1.2/dataTables.dateTime.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>


<script>

    $(document).ready(function () {

       // console.log("Initializing DataTable...");
        console.log(moment);

        // Put # rows displayed/total at top of table also.
        var table = $('#jobTable').DataTable({
            paging: false,
            // deferRender: true, // Enable deferred rendering
            dom: '<"top"if>rt<"bottom"i><"clear">', // f for search/filter box
            language: {
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoFiltered: "(filtered from _MAX_ total entries)"
            },
                columnDefs: [
                {
                     targets: 38,   // Index of the 'mem' column, index starts at 0
                    //targets: "memoryBytes",  // Target using class name (th)
                    visible: false // Hide raw bytes
                },
                {
                    // Enable sorting on the hidden column for formatted memory
                    //targets: "formattedMemory",
                    targets: 39,
                    orderData: 38 // Sort the formattedMemory column using the hidden memoryBytes column
                },
                    {
                        // Format epoch data to a human-readable date
                        //   targets: 'formatEpoch',  // Target using class name for 'ctime', etc <th class="formatEpoch">
                        targets: [8, 14, 17, 20, 22, 28],
                        render: function (data, type, row) {
                            //console.log("Incoming data to render:", data); // Debug incoming row data for this column
                            //  return DataTable.render.datetime('x', 'YYYY-MM-DDTHH:mm:ssZ')(data);
                            if (type === 'display' || type === 'filter') {
                                return moment(parseInt(data))
                                    .tz(Intl.DateTimeFormat().resolvedOptions().timeZone) // Automatically use browser's time zone
                                    .format('YYYY-MM-DDTHH:mm:ss z'); // 'z' for abbreviation like MST or PST
                            }
                            return data; // Raw data for sorting

                        }
                    }
            ]

            }

        ); // End DataTable

       // console.log("DataTable initialized:");

        /**
         * Convert memory string (e.g., "2tb", "500gb") to numeric GB value.
         */
        function convertMemToGB(mem) {
            //console.log("Converting to GB:", mem);

            const pattern = /^(\d+(?:\.\d+)?)\s*(kb|mb|gb|tb)$/i;
            const match = mem.match(pattern);

            if (match) {
                let value = parseFloat(match[1]);
                const unit = match[2].toLowerCase();

                switch (unit) {
                    case "tb":
                        value *= 1024; // 1 TB = 1024 GB
                        break;
                    case "mb":
                        value /= 1024; // 1 MB = 1/1024 GB
                        break;
                    case "kb":
                        value /= (1024 * 1024); // 1 KB = 1/(1024*1024) GB
                        break;
                    case "gb":
                    default:
                        break; // Already in GB
                }
                return value; // Numeric GB value
            }
            return 0; // Fallback value if parsing fails
        }

        /**
         * Format memory values to display as "<value> GB".
         */
        function formatMemToGB(mem) {
            const valueInGB = convertMemToGB(mem);

            // Check if the value is a whole number
            if (Number.isInteger(valueInGB)) {
                return `${valueInGB} GB`; // No decimal if whole number
            } else {
                return `${valueInGB.toFixed(2)} GB`; // Keep 2 decimal places if not
            }

            console.log("Formatted Memory:", formatted);
            return formatted;
        }

        function renderEpochColumn(data, type) {

            console.log("---Raw column epoch Data: ", data);
            // Convert the raw data to a number
            const epoch = parseInt(data, 10);

            // Handle invalid or empty data
            if (isNaN(epoch) || !data) {
                return type === "display" || type === "filter" ? "Invalid Date" : data;
            }
            console.log("---Epoch: ", epoch);

            // if (type === "display" || type === "filter") {
                formattedEpoch = moment(epoch).toLocaleString(); // Use browser locale
                console.log("---Formatted Epoch: ", formattedEpoch);
                return formattedEpoch;
            // } else if (type === "sort" || type === "type") {
            //     return epoch; // Raw epoch for sorting
            // }
            // return data; // Default raw data
        }

        // too slow
        function updateTableWithFormattedEpochs() {

            const elements = document.querySelectorAll('.epoch-column'); // Select all target columns

            elements.forEach(column => {

                // Get the span's text content (assuming the span contains the epoch value)
                // const span = column.querySelector('span'); // Select the span inside the column
                const epoch = parseInt(column.innerText, 10); // Convert text to integer (epoch time)

                if (!isNaN(epoch)) { // Check that the epoch is a valid number

                    // Format the epoch value and update the column's content
                    const formattedDate = formatEpoch(epoch); // Call your function with the epoch value
                    column.innerText = formattedDate; // Update the column with the formatted date
                }
            });
        }

        function formatEpoch(epoch) {

            // Convert the epoch time (in milliseconds) to a JavaScript Date object
            const date = new Date(epoch);

            //  return date.toLocaleString(); // Format the date as per browser language setting, browser time zone

            // Use Intl.DateTimeFormat to format the date in the browser's local time zone
            // return formattedEpoch = new Intl.DateTimeFormat('en-US', {
            return formattedEpoch = new Intl.DateTimeFormat(undefined, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short' // Includes the time zone abbreviation (e.g., PST, EDT)
            }).format(date);

        }

        // Function to update all targeted columns with the time zone abbreviation
        // function updateTableWithTimeZone() {
        //
        //     const timeZoneAbbr = getCurrentTimeZoneAbbreviation(); // Fetch timezone abbreviation
        //     const elements = document.querySelectorAll('.timezone-column'); // Select all target columns
        //
        //     elements.forEach(column => {
        //         column.innerText = timeZoneAbbr; // Update each column
        //     });
        // }

        // Call the function to update all relevant table columns
        // updateTableWithTimeZone();

        //updateTableWithFormattedEpochs();
    });



</script>

</body>
</html>